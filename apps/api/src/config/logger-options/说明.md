# `serializers`的作用和机制

## `serializers`的作用

`serializers`是Pino日志系统中的**序列化器配置**，用于控制如何将复杂的对象（如HTTP请求和响应）转换为可序列化的格式进行日志记录。

## 详细解释

### 1. **为什么需要序列化器？**

**问题：**
- HTTP请求和响应对象包含大量信息（如完整的headers、复杂的body等）
- 直接记录这些对象会导致日志过于冗长，包含敏感信息
- 某些对象可能包含循环引用，无法直接序列化

**解决方案：**
- 通过序列化器提取和格式化关键信息
- 过滤掉敏感数据和不必要的字段
- 确保日志的可读性和安全性

### 2. **当前配置分析**

#### **请求序列化器 (`req`)**
```typescript
req: (req: {
  id: any;
  method: any;
  url: any;
  headers: { [x: string]: any };
  ip: any;
  body: any;
  query: any;
  params: any;
}) => {
  return {
    id: req.id,                    // 请求ID
    method: req.method,            // HTTP方法 (GET, POST, etc.)
    url: req.url,                  // 请求URL
    userAgent: req.headers['user-agent'],     // 用户代理
    language: req.headers['accept-language'], // 语言偏好
    ip: req.ip,                    // 客户端IP
    body: req.body,                // 请求体
    query: req.query,              // 查询参数
    params: req.params,            // 路径参数
  };
}
```

**提取的关键信息：**
- **请求标识**：`id` - 用于请求追踪
- **请求元数据**：`method`, `url` - 基本请求信息
- **客户端信息**：`userAgent`, `language`, `ip` - 客户端特征
- **请求数据**：`body`, `query`, `params` - 请求参数

#### **响应序列化器 (`res`)**
```typescript
res: (res: { statusCode: any }) => {
  return {
    statusCode: res.statusCode,    // HTTP状态码
  };
}
```

**提取的关键信息：**
- **响应状态**：`statusCode` - 请求处理结果

### 3. **实际日志输出示例**

**序列化前的原始请求对象：**
```javascript
{
  id: "req-123",
  method: "POST",
  url: "/v1/users",
  headers: {
    "authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user-agent": "Mozilla/5.0...",
    "accept-language": "zh-CN,zh;q=0.9,en;q=0.8",
    "content-type": "application/json",
    "x-forwarded-for": "192.168.1.100",
    // ... 更多headers
  },
  ip: "192.168.1.100",
  body: { username: "john", email: "john@example.com" },
  query: { page: "1", limit: "10" },
  params: { id: "123" },
  // ... 大量其他属性
}
```

**序列化后的日志记录：**
```json
{
  "level": "info",
  "time": "2024-01-15T10:30:00.000Z",
  "reqId": "req-123",
  "req": {
    "id": "req-123",
    "method": "POST",
    "url": "/v1/users",
    "userAgent": "Mozilla/5.0...",
    "language": "zh-CN,zh;q=0.9,en;q=0.8",
    "ip": "192.168.1.100",
    "body": { "username": "john", "email": "john@example.com" },
    "query": { "page": "1", "limit": "10" },
    "params": { "id": "123" }
  },
  "res": {
    "statusCode": 201
  }
}
```

### 4. **主要优势**

1. **信息过滤**：只记录必要信息，避免日志冗余
2. **安全考虑**：避免记录敏感信息（如完整headers中的token）
3. **性能优化**：减少日志大小，提升写入性能
4. **可读性**：结构化的日志格式，便于分析和调试
5. **一致性**：确保所有请求日志格式统一

### 5. **与其他配置的配合**

- **`customProps`**：添加用户上下文信息
- **`genReqId`**：生成请求ID
- **`quietReqLogger`**：控制日志输出频率

这种配置确保了日志系统既能提供足够的调试信息，又保持了良好的性能和安全性。